{% extends 'layout.html' %}
{% block content %}
<div class="container review">
    <article class="restaurant_info">
        <div class="column-contents" id="restaurant">
        </div>
        <div class="container photo-box">
            <aside id="restaurant-photo" class="restaurant-photos row">
            </aside>
        </div>
    </article>
    <!--ë§¨ìœ„ì— ë§›í‰ê°€ í†µê³„ ë¶€ë¶„-->
    <div class="header">
        <ul class="total_review_count" id="total_count"></ul>
        <ul class="header_detail_reaction">
            <li class="detail_total_review_count"><input type="radio" onclick="total_view_review()" class="btn-check"
                                                         name="btnradio" id="btnradio1" autocomplete="off" checked>
                <label class="btn btn-outline-secondary btn-sm" id="total" for="btnradio1">ì „ì²´ (0)</label>
            </li>
            <li class="detail_good_review_count"><input type="radio" onclick="good_filter_review()" class="btn-check"
                                                        name="btnradio" id="btnradio2" autocomplete="off">
                <label class="btn btn-outline-secondary btn-sm" id="good" for="btnradio2">ë§›ìˆë‹¤ (0)</label>
            </li>
            <li class="detail_soso_review_count"><input type="radio" onclick="soso_filter_review()" class="btn-check"
                                                        name="btnradio" id="btnradio3" autocomplete="off">
                <label class="btn btn-outline-secondary btn-sm" id="soso" for="btnradio3">ê´œì°®ë‹¤ (0)</label>
            </li>
            <li class="detail_soso_review_count"><input type="radio" onclick="bad_filter_review()" class="btn-check"
                                                        name="btnradio" id="btnradio4" autocomplete="off">
                <label class="btn btn-outline-secondary btn-sm" id="bad" for="btnradio4">ë³„ë¡œë‹¤ (0)</label>
            </li>



<!--            <li class="lead">-->
<!--                <button onclick="openClose()" id="btn-post-box" type="button" class="btn btn-primary">ì ‘ê¸°</button>-->
<!--            </li>-->
        </ul>
    </div>

    <!--ë‹‰ë„¤ì„/í›„ê¸°/ë§›í‰ê°€ í›„ ëŒ“ê¸€ ë‹¤ëŠ” ë¶€ë¶„-->
    <div class="review_box" id="open_review_box">
        <!--ë‹‰ë„¤ì„-->
        <div class="form-floating">
            <textarea class="form-control nickname_input-control" placeholder="ë‹‰ë„¤ì„" id="review_nickname"></textarea>
            <label class="textarea-label form-check-label" for="floatingTextarea">ë‹‰ë„¤ì„</label>
        </div>
        <!--ì½”ë©˜íŠ¸ ë‚´ìš©-->
        <div class="form-floating">
            <textarea class="form-control comment_input-control" placeholder="ì†”ì§í•œ í›„ê¸°ë¥¼ ì ì–´ì£¼ì„¸ìš”" id="review_comment"
                      style="height: 100px"></textarea>
            <label class="textarea-label form-check-label" for="flexRadioDefault1">ì†”ì§í•œ í›„ê¸°ë¥¼ ì ì–´ì£¼ì„¸ìš”</label>
        </div>
        <!--í‰ê°€-->
        <div class="review-score">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault1"
                       value="ë§›ìˆì—ˆì–´ìš”">
                <label class="form-check-label" for="flexRadioDefault1">ğŸ˜€ ë§›ìˆë‹¤</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault2"
                       value="ê´œì°®ì•˜ì–´ìš”" checked>
                <label class="form-check-label" for="flexRadioDefault2">ğŸ˜ ê´œì°®ë‹¤</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="flexRadioDefault" id="flexRadioDefault3"
                       value="ë³„ë¡œì˜€ì–´ìš”">
                <label class="form-check-label" for="flexRadioDefault3">ğŸ˜“ ë³„ë¡œë‹¤</label>
            </div>
        </div>
        <!--ë²„íŠ¼-->
        <button onclick="save_review()" type="button" class="btn btn-primary">ëŒ“ê¸€ ë‹¬ê¸°</button>
    </div>

    <!--ì„œë²„ì—ì„œ ë¿Œë ¤ì£¼ëŠ” ëŒ“ê¸€ë“¤-->
    <div id="append_review" class="list-group list-group-flush"
         style="position: absolute;left:551.5px;padding-top: 50px;margin-top: 50px;">
    </div>


<script>
    $(document).ready(function () {
        show_resDetail();
        show_review();
    });

    function show_resDetail() {
        var url_string = window.location.href;
        var url = new URL(url_string);
        var param = url.searchParams.get("id");
        console.log(param);
        $.ajax({
            type: 'GET',
            url: "/resDetail?mangoId=" + param,
            dataType: 'json',
            data: {},
            success: function (res) {
                console.log(res)
                let resDetail = res['resDetail']
                let address = resDetail['address']
                let district = resDetail['district']
                let kind = resDetail['kind']
                let name = resDetail['name']
                let businesshours = resDetail['businesshours']
                let tel = resDetail['tel']
                let starMango = resDetail['starMango']
                let starDining = resDetail['starDining']
                let total_score = resDetail['starTotal']

                let cnt = parseInt(`resDetail['total_score']`);
                let starCnt = "";
                for (let j = 0; j < cnt; j++) {
                    starCnt += "â­";
                }

                let imgList = res['imgList']

                let temp_html = `
                                        <h1 style="margin-bottom: 20px;">${name}</h1>
                                        <table>
                                            <tbody>
                                                <tr>
                                                    <th>
                                                        ì£¼ì†Œ
                                                    </th>
                                                    <td>
                                                    ${address}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>
                                                        ìŒì‹ì¢…ë¥˜
                                                    </th>
                                                    <td>
                                                    ${kind}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>
                                                        ì˜ì—…ì‹œê°„
                                                    </th>
                                                    <td>
                                                    ${businesshours}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>
                                                        ì „í™”ë²ˆí˜¸
                                                    </th>
                                                    <td>
                                                        ${tel}
                                                    </td>
                                                </tr>
                                            </tbody>

                                        </table>

                                        <br>
                                        <div class="restaurant-score">
                                            <h4>ì´ <span>${total_score}</span>${starCnt}</h4>
                                            <span><img src="../static/img/logo-mango.svg"> ${starMango}</span>
                                            <span><img src="../static/img/logo-dining.svg"> ${starDining}</span>
                                        </div>`

                $('#restaurant').append(temp_html)

                for (let i = 0; i < imgList.length; i++) {
                    console.log(imgList[i]);
                    let temp_html2 = `<div class="col-12 col-md-3 img-detail">
                                        <div id="img-detail" style="background-image: url(${imgList[i].url});"></div>
                                    </div>
                                    `

                    $('#restaurant-photo').append(temp_html2)
                }

            }
        });
    }

    function show_review() {
            var url_string = window.location.href;
            var url = new URL(url_string);
            var param = url.searchParams.get("id");
        $.ajax({
            type: "GET",
            url: "/detail/resDetail?mangoId="+param,
            data: {},
            success: function (response) {
                //í¬ë¬¸ ëŒë¦¬ê¸°ìš©
                let rows = response['rows']

                //DB ë°ì´í„°ë¥¼ list ê¸¸ì´ë¡œ ì¹´ìš´íŠ¸í•´ì„œ í´ë¼ì— ë¿Œë¦¬ê¸°
                var total = response['total']
                var bad = response['bad']
                var soso = response['soso']
                var good = response['good']

                //ì „ì²´ ëŒ“ê¸€ ê°œìˆ˜
                $('#total_count').text("í›„ê¸° (" + total + ")")

                //ì„¸ë¶€ ëŒ“ê¸€ ê°œìˆ˜
                $('#bad').text("ë³„ë¡œë‹¤ (" + bad + ")")
                $('#soso').text("ê´œì°®ë‹¤ (" + soso + ")")
                $('#good').text("ë§›ìˆë‹¤ (" + good + ")")
                $('#total').text("ì „ì²´ (" + total + ")")

                for (i = 0; i < rows.length; i++) {
                    let nickname = rows[i]['nickname']
                    let comment = rows[i]['comment']
                    let score = rows[i]['score']
                    let time = rows[i]['time']

                    if (score == 'ë§›ìˆì—ˆì–´ìš”') {
                        var temp_html3 = `<li class="list-group-item good">
                                            <div class="comment-details" style="font-size:48px; height: 48px;">&#128512;</div>
                                            <div class="each_detail_reaction">
                                                <p style="font-weight: bold">${nickname}</p>
                                                <small style="color: gray"><p>${time}</p></small>
                                                <p>${comment}</p>
                                            </div>
                                        </li>`
                    } else if (score == 'ê´œì°®ì•˜ì–´ìš”') {
                        var temp_html3 = `<li class="list-group-item soso">
                                            <div class="comment-details" style="font-size:48px; height: 48px;">&#128528;</div>
                                            <div class="each_detail_reaction">
                                                <p style="font-weight: bold">${nickname}</p>
                                                <small style="color: gray"><p>${time}</p></small>
                                                <p>${comment}</p>
                                            </div>
                                        </li>`
                    } else if (score == 'ë³„ë¡œì˜€ì–´ìš”') {
                        var temp_html3 = `<li class="list-group-item bad">
                                            <div class="comment-details" style="font-size:48px; height: 48px;">&#128531;</div>
                                            <div class="each_detail_reaction">
                                                <p style="font-weight: bold">${nickname}</p>
                                                <small style="color: gray"><p>${time}</p></small>
                                                <p>${comment}</p>
                                            </div>

                                        </li>`
                    }
                    $('#append_review').append(temp_html3)
                }
            }
        })
    }

    function save_review() {
        let review_nickname = $('#review_nickname').val()
        let review_comment = $('#review_comment').val()
        let emotion = $('input[name=flexRadioDefault]:checked').val();

        var url_string = window.location.href;
        var url = new URL(url_string);
        var param = url.searchParams.get("id");

        $.ajax({
            type: "POST",
            url: "/detail/resDetail",
            data: {
                review_nickname_give: review_nickname,
                review_comment_give: review_comment,
                emotion_give: emotion,
                pageid: param
            },
            success: function (response) {
                alert(response["msg"])
                window.location.reload()
            }
        });
    }

    function good_filter_review() {
        if ($('.each_detail_reaction:contains("ë§›ìˆì—ˆì–´ìš”")')) {
            $('.good').show();
            $('.soso').hide();
            $('.bad').hide();
        }
    }

    function soso_filter_review() {
        if ($('.each_detail_reaction:contains("ê´œì°®ì•˜ì–´ìš”")')) {
            $('.good').hide();
            $('.soso').show();
            $('.bad').hide();
        }
    }

    function bad_filter_review() {
        if ($('.each_detail_reaction:contains("ë³„ë¡œì˜€ì–´ìš”")')) {
            $('.good').hide();
            $('.soso').hide();
            $('.bad').show();
        }
    }

    function total_view_review() {
        $('.good').show();
        $('.soso').show();
        $('.bad').show();
    }

    function openClose() {
        if ($("#open_review_box").css("display") == "block") {
            $("#open_review_box").hide();
            $("#btn-post-box").text("ëŒ“ê¸€ ì¶”ê°€ í•˜ê¸°");
        } else {
            $("#open_review_box").show();
            $("#btn-post-box").text("ì ‘ê¸°");
        }
    }
</script>
{% endblock %}